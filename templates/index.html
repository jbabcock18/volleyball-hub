<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Texas Beach Volleyball Tournaments</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <main class="container">
      <header class="page-header">
        <h1>Texas Beach Volleyball Tournaments</h1>
        <section class="community-strip" aria-label="Community Actions">
          <a class="community-link" href="https://forms.gle/sfmqGxywwAKuJEDd9" target="_blank" rel="noreferrer">Send suggestion</a>
          <details class="email-signup">
            <summary>Email updates</summary>
            <div class="email-signup-panel">
              <script async data-uid="27d4e0a620" src="https://volleyball-hub.kit.com/27d4e0a620/index.js"></script>
            </div>
          </details>
        </section>
      </header>

      <section class="controls">
        <div class="control-field control-search">
          <label for="search">Search</label>
          <input id="search" type="text" placeholder="Search tournaments by name" />
        </div>
        <div class="control-field control-filter">
          <label for="source-toggle">Hosts</label>
          <div class="multi-select" id="source-filter">
            <button id="source-toggle" class="multi-select-toggle" type="button" aria-haspopup="true" aria-expanded="false">
              All sources
            </button>
            <div id="source-menu" class="multi-select-menu" hidden>
              <label class="multi-select-option">
                <input id="all-sources" type="checkbox" checked />
                <span>All sources</span>
              </label>
              {% for source in sources %}
              <label class="multi-select-option">
                <input class="source-checkbox" type="checkbox" value="{{ source }}" />
                <span>{{ source }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
        </div>
      </section>

      <p class="meta">Last updated: {{ updated_at }}</p>
      {% if refresh_notice %}
      <p class="refresh-notice">{{ refresh_notice }}</p>
      {% endif %}

      {% if errors %}
      <section class="errors">
        <h2>Scrape Warnings</h2>
        <ul>
          {% for err in errors %}
          <li>{{ err }}</li>
          {% endfor %}
        </ul>
      </section>
      {% endif %}

      <section class="table-wrap">
        <table id="events-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Tournament</th>
              <th>Source</th>
              <th>Location</th>
              <th>Link</th>
            </tr>
          </thead>
          <tbody>
            {% for t in tournaments %}
            <tr data-title="{{ t.title|lower }}" data-source="{{ t.source }}">
              <td>{{ t.date|display_date }}</td>
              <td>{{ t.title }}</td>
              <td>{{ t.source }}</td>
              <td>{{ t.location or 'N/A' }}</td>
              <td><a href="{{ t.link }}" target="_blank" rel="noreferrer">Open</a></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>
    </main>

    <script>
      const searchInput = document.getElementById("search");
      const sourceFilter = document.getElementById("source-filter");
      const sourceToggle = document.getElementById("source-toggle");
      const sourceMenu = document.getElementById("source-menu");
      const allSourcesCheckbox = document.getElementById("all-sources");
      const sourceCheckboxes = Array.from(document.querySelectorAll(".source-checkbox"));
      const emailSignup = document.querySelector(".email-signup");
      const emailSignupPanel = document.querySelector(".email-signup-panel");
      const rows = Array.from(document.querySelectorAll("#events-table tbody tr"));

      function selectedSources() {
        return sourceCheckboxes.filter((checkbox) => checkbox.checked).map((checkbox) => checkbox.value);
      }

      function updateToggleLabel() {
        const selected = selectedSources();
        if (selected.length === sourceCheckboxes.length) {
          sourceToggle.textContent = "All sources";
          return;
        }
        if (selected.length === 0) {
          sourceToggle.textContent = "No sources";
          return;
        }
        if (selected.length === 1) {
          sourceToggle.textContent = selected[0];
          return;
        }
        sourceToggle.textContent = `${selected.length} sources`;
      }

      function applyFilters() {
        const q = searchInput.value.trim().toLowerCase();
        const selected = selectedSources();
        const hasSourceFilter = selected.length < sourceCheckboxes.length;

        rows.forEach((row) => {
          const title = row.dataset.title || "";
          const rowSource = row.dataset.source || "";
          const matchesSearch = !q || title.includes(q);
          const matchesSource = !hasSourceFilter ? true : selected.includes(rowSource);
          row.style.display = matchesSearch && matchesSource ? "" : "none";
        });
      }

      function setAllSources(checked) {
        sourceCheckboxes.forEach((checkbox) => {
          checkbox.checked = checked;
        });
        allSourcesCheckbox.checked = checked;
      }

      function syncAllSourcesCheckbox() {
        const checkedCount = sourceCheckboxes.filter((checkbox) => checkbox.checked).length;
        allSourcesCheckbox.checked = checkedCount === sourceCheckboxes.length;
      }

      function ensureKitSubmitLabel() {
        if (!emailSignupPanel) return;
        const submitButtons = emailSignupPanel.querySelectorAll(".formkit-submit");
        submitButtons.forEach((button) => {
          const label = (button.textContent || "").trim();
          if (!label) {
            button.textContent = "Subscribe";
          }
        });
      }

      sourceToggle.addEventListener("click", () => {
        const open = !sourceMenu.hidden;
        sourceMenu.hidden = open;
        sourceToggle.setAttribute("aria-expanded", String(!open));
      });

      document.addEventListener("click", (event) => {
        if (!sourceFilter.contains(event.target)) {
          sourceMenu.hidden = true;
          sourceToggle.setAttribute("aria-expanded", "false");
        }
        if (emailSignup && emailSignup.open && !emailSignup.contains(event.target)) {
          emailSignup.open = false;
        }
      });

      allSourcesCheckbox.addEventListener("change", () => {
        setAllSources(allSourcesCheckbox.checked);
        updateToggleLabel();
        applyFilters();
      });

      sourceCheckboxes.forEach((checkbox) => {
        checkbox.addEventListener("change", () => {
          syncAllSourcesCheckbox();
          updateToggleLabel();
          applyFilters();
        });
      });

      if (emailSignupPanel) {
        const observer = new MutationObserver(() => ensureKitSubmitLabel());
        observer.observe(emailSignupPanel, { childList: true, subtree: true });
      }

      searchInput.addEventListener("input", applyFilters);
      setAllSources(true);
      updateToggleLabel();
      applyFilters();
      ensureKitSubmitLabel();
    </script>
  </body>
</html>
